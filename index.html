<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="Retro Index · 经典小游戏的现代重制。Snake、Gomoku 等，极简渐变与顺滑动效，支持深浅色主题。"/>
  <title>Retro Index · 经典小游戏的现代重制</title>

  <!-- 字体 & p5 -->
  <link href="https://fonts.googleapis.com/css2?family=Exo:wght@700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>

  <style>
    /* =========================
       设计系统：颜色与半径
       ========================= */
    :root{
      --bg-0:#0f1c24;        /* 冷灰蓝深 */
      --bg-1:#324450;        /* 冷灰蓝浅 */
      --tx-0:#d8e9f0;        /* 文字默认 */
      --tx-1:#b8c7d6;        /* 次级文字 */
      --pri-0:#00e0ff;       /* 霓虹青 */
      --pri-1:#9caedb;       /* 冷蓝紫 */
      --card-bg:rgba(10,20,28,.55);
      --card-shadow:0 12px 32px rgba(0,224,255,.14);
      --card-shadow-hover:0 16px 48px rgba(0,224,255,.22);
      --chip-bg:rgba(156,174,219,.15);
      --chip-tx:#dfe7ff;

      --rad-xl:24px;
      --rad-lg:16px;
      --rad-sm:10px;

      --focus: 0 0 0 3px rgba(0,224,255,.35);
    }
    body.dark-theme{
      --bg-0:#2a1400;        /* 暖橙深 */
      --bg-1:#b64b00;        /* 暖橙浅 */
      --tx-0:#fff2e2;
      --tx-1:#ffe3c7;
      --pri-0:#ff7a00;
      --pri-1:#ffd28a;
      --card-bg:rgba(56,24,0,.55);
      --card-shadow:0 12px 32px rgba(255,122,0,.20);
      --card-shadow-hover:0 16px 48px rgba(255,122,0,.30);
      --chip-bg:rgba(255,210,138,.15);
      --chip-tx:#fff2e2;
      --focus: 0 0 0 3px rgba(255,122,0,.4);
    }

    /* ============ 全局 ============ */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--tx-0);
      background:linear-gradient(180deg,var(--bg-0) 0%,var(--bg-1) 100%);
      overflow-x:hidden;
      transition:background .45s ease,color .45s ease;
      animation:fadeIn 1s ease both;
    }
    @keyframes fadeIn{from{opacity:.0}to{opacity:1}}
    a{color:inherit; text-decoration:none}
    img{display:block; max-width:100%}
    button{font:inherit}

    /* ============ 顶栏 ============ */
    nav{
      position:sticky; top:0; z-index:100;
      display:flex; align-items:center; gap:20px; justify-content:center;
      padding:16px 20px; transition:all .3s ease;
      background:transparent;
    }
    nav.scrolled{background:rgba(0,0,0,.25); backdrop-filter:blur(10px); padding:10px 20px}
    .nav-inner{width:min(1100px,92vw); display:flex; align-items:center; gap:16px}
    .brand{display:flex; align-items:center; gap:10px; margin-right:auto}
    .brand-badge{
      width:32px; height:32px; border-radius:9px; display:grid; place-items:center;
      background:linear-gradient(135deg,var(--pri-0),var(--pri-1));
      color:#07161d; font-weight:800; font-family:'Exo',sans-serif;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
    }
    .brand h1{
      font-size:18px; margin:0; letter-spacing:.3px; font-weight:800; font-family:'Exo',sans-serif;
      background:linear-gradient(90deg,var(--pri-0),var(--pri-1));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .nav-links{display:flex; gap:18px; align-items:center}
    .nav-links a{position:relative; font-weight:600; opacity:.95}
    .nav-links a::after{
      content:''; position:absolute; left:0; bottom:-6px; height:2px; width:0;
      background:linear-gradient(90deg,var(--pri-0),var(--pri-1)); transition:width .25s ease;
    }
    .nav-links a:hover::after{width:100%}

    .searchbar{
      position:relative; flex:1 1 280px; max-width:380px;
    }
    .searchbar input{
      width:100%; padding:10px 36px 10px 12px; border-radius:999px; border:1px solid transparent;
      background:rgba(255,255,255,.06); color:var(--tx-0); outline:none;
      transition:box-shadow .25s ease,border-color .25s ease;
    }
    .searchbar input:focus{box-shadow:var(--focus); border-color:transparent}
    .searchbar .kbd{
      position:absolute; right:8px; top:50%; transform:translateY(-50%);
      font-size:12px; opacity:.8; padding:2px 6px; border-radius:6px;
      background:rgba(255,255,255,.08)
    }

    #theme-toggle{
      background:linear-gradient(135deg,var(--pri-0),var(--pri-1));
      color:#0a1a22; border:none; border-radius:999px; padding:8px 12px; font-weight:700;
      cursor:pointer; transition:transform .25s ease, box-shadow .25s ease; white-space:nowrap;
    }
    #theme-toggle:hover{transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.25)}
    #theme-toggle:focus-visible{outline:none; box-shadow:var(--focus)}

    /* ============ Hero ============ */
    .hero{
      padding:68px 20px 28px; text-align:center;
    }
    .hero h2{
      margin:0 0 10px; font-size:42px; font-weight:800; line-height:1.1; letter-spacing:.3px;
      font-family:'Exo',sans-serif;
      background:linear-gradient(90deg,var(--pri-0),var(--pri-1));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .hero p{margin:0 auto; max-width:560px; opacity:.92}

    /* ============ 快捷标签（可扩展分类） ============ */
    .tags{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin:18px auto 10px;
    }
    .chip{
      padding:8px 12px; border-radius:999px; background:var(--chip-bg); color:var(--chip-tx);
      font-size:13px; border:1px solid rgba(255,255,255,.08);
      cursor:pointer; user-select:none; transition:transform .2s ease, box-shadow .2s ease;
    }
    .chip:hover{transform:translateY(-1px)}
    .chip.active{box-shadow:0 0 0 2px var(--pri-0) inset}

    /* ============ 游戏网格 ============ */
    .section{padding:14px 20px 60px}
    .container{width:min(1100px,92vw); margin:0 auto}
    .section-title{display:flex; align-items:center; gap:10px; margin-bottom:16px}
    .section-title h3{margin:0; font-size:18px; opacity:.9}
    .section-title .dot{width:8px; height:8px; border-radius:50%; background:var(--pri-0); box-shadow:0 0 12px var(--pri-0)}

    .game-grid{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:26px;
    }
    .game-card{
      position:relative; padding:18px; border-radius:var(--rad-xl); background:var(--card-bg);
      box-shadow:var(--card-shadow);
      transition:transform .35s ease, box-shadow .35s ease, opacity .6s ease-out;
      opacity:0; transform:translateY(24px);
      outline:none;
    }
    .game-card.visible{opacity:1; transform:translateY(0)}
    .game-card:hover{transform:translateY(-10px); box-shadow:var(--card-shadow-hover)}
    .game-card:focus-visible{box-shadow:var(--focus), var(--card-shadow)}

    /* 方形缩略图（保持 1:1） */
    .thumb{
      width:100%; aspect-ratio:1/1; border-radius:var(--rad-lg); overflow:hidden;
      display:block; margin-bottom:14px; position:relative;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
      transform:translateZ(0);
    }
    .thumb canvas{width:100% !important; height:100% !important; display:block}

    /* 轻微视差（悬浮时） */
    .game-card:hover .thumb{transform:translateY(-2px)}
    .title-row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .title-row h4{margin:0; font-size:20px; font-weight:800; font-family:'Exo',sans-serif}
    .badge{
      font-size:12px; padding:4px 8px; border-radius:999px;
      background:linear-gradient(135deg,var(--pri-0),var(--pri-1));
      color:#07161d; font-weight:800;
    }
    .desc{font-size:14px; color:var(--tx-1); margin:8px 0 14px}
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:999px;
      border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.06); color:var(--tx-0);
      font-weight:700; transition:transform .2s ease, box-shadow .2s ease, background .2s ease;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.25)}
    .btn.primary{border:none; background:linear-gradient(135deg,var(--pri-0),var(--pri-1)); color:#0a1a22}
    .meta{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .meta .pill{font-size:12px; opacity:.9; padding:4px 8px; border:1px dashed rgba(255,255,255,.15); border-radius:999px}

    /* ============ 页脚 ============ */
    footer{padding:32px 20px; border-top:1px solid rgba(255,255,255,.08); opacity:.9}
    .foot{width:min(1100px,92vw); margin:0 auto; display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between}
    .foot small{opacity:.7}

    /* 响应式 */
    @media (max-width:768px){
      .hero{padding-top:54px}
      .hero h2{font-size:32px}
      .nav-links{display:none}
    }
    @media (prefers-reduced-motion:reduce){
      *,*:before,*:after{transition:none !important; animation:none !important}
      .game-card{opacity:1 !important; transform:none !important}
    }
  </style>
</head>
<body>
  <!-- 顶栏 -->
  <nav role="navigation" aria-label="主导航">
    <div class="nav-inner">
      <a class="brand" href="/index.html" aria-label="返回首页">
        <span class="brand-badge" aria-hidden="true">R</span>
        <h1>Retro&nbsp;Index</h1>
      </a>

      <div class="nav-links" aria-hidden="false">
        <a href="/index.html">Home</a>
        <a href="/Games/snake.html">Snake</a>
        <a href="/Games/Gomoku.html">Gomoku</a>
      </div>

      <div class="searchbar" role="search">
        <input id="search" type="search" placeholder="搜索游戏（支持标签）…" aria-label="搜索游戏（输入关键字或标签）" />
        <span class="kbd" aria-hidden="true">/</span>
      </div>

      <button id="theme-toggle" aria-label="切换主题" aria-pressed="false">切换主题</button>
    </div>
  </nav>

  <!-- 顶部主视觉 -->
  <header class="hero" role="banner">
    <h2>经典游戏 · 现代重制</h2>
    <p>极简渐变风、顺滑动画、深浅色主题、自适应与可达性优化。用最干净的界面，玩最纯粹的乐趣。</p>

    <!-- 快捷标签（可扩展分类） -->
    <div class="tags" aria-label="快速筛选">
      <button class="chip active" data-filter="all" aria-pressed="true">全部</button>
      <button class="chip" data-filter="board">棋类</button>
      <button class="chip" data-filter="arcade">街机</button>
      <button class="chip" data-filter="retro">复古</button>
    </div>
  </header>

  <!-- 游戏列表 -->
  <section class="section" aria-label="游戏列表">
    <div class="container">
      <div class="section-title"><span class="dot" aria-hidden="true"></span><h3>Now Playing</h3></div>

      <div id="grid" class="game-grid" aria-live="polite">
        <!-- Snake -->
        <article class="game-card" tabindex="0" role="article" data-tags="arcade retro" data-title="snake">
          <a href="/Games/snake.html" class="thumb" id="snake-canvas" aria-label="打开 Snake"></a>

          <div class="title-row">
            <h4>Snake</h4>
            <span class="badge">FAST</span>
          </div>

          <p class="desc">极简块状像素与顺滑路径动画，轻巧却耐玩。</p>

          <div class="actions">
            <a class="btn primary" href="/Games/snake.html" aria-label="Play Snake 立即开始">Play</a>
            <a class="btn" href="/Games/snake.html#about" aria-label="查看 Snake 详情">详情</a>
          </div>

          <div class="meta" aria-label="Snake 元信息">
            <span class="pill">上手快</span><span class="pill">键盘操作</span>
          </div>
        </article>

        <!-- Gomoku -->
        <article class="game-card" tabindex="0" role="article" data-tags="board retro" data-title="gomoku">
          <a href="/Games/Gomoku.html" class="thumb" id="gomoku-canvas" aria-label="打开 Gomoku"></a>

          <div class="title-row">
            <h4>Gomoku</h4>
            <span class="badge">TACTIC</span>
          </div>

          <p class="desc">五子连珠，干净盘面与呼吸光提示最近一步。</p>

          <div class="actions">
            <a class="btn primary" href="/Games/Gomoku.html" aria-label="Play Gomoku 立即开始">Play</a>
            <a class="btn" href="/Games/Gomoku.html#about" aria-label="查看 Gomoku 详情">规则</a>
          </div>

          <div class="meta" aria-label="Gomoku 元信息">
            <span class="pill">策略</span><span class="pill">单机/本地对战</span>
          </div>
        </article>
      </div>
    </div>
  </section>

  <!-- 页脚 -->
  <footer role="contentinfo">
    <div class="foot">
      <small>© <span id="y"></span> Retro Index · Made with p5.js</small>
      <small>主题：冷灰蓝 / 暖橙沙尘 · <a href="#" id="toTop">回到顶部</a></small>
    </div>
  </footer>

  <!-- =========================
       交互脚本：主题 / 搜索筛选 / 动画 / p5 缩略图
       ========================= -->
  <script>
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    // 年份
    $('#y').textContent = new Date().getFullYear();

    // 回顶
    $('#toTop').addEventListener('click',(e)=>{e.preventDefault(); window.scrollTo({top:0,behavior:'smooth'})});

    // 顶栏滚动
    let ticking=false;
    window.addEventListener('scroll',()=>{
      if(!ticking){
        requestAnimationFrame(()=>{
          const nav=document.querySelector('nav');
          if(window.scrollY>100) nav.classList.add('scrolled'); else nav.classList.remove('scrolled');
          ticking=false;
        }); ticking=true;
      }
    });

    // 卡片出现动画
    const io=new IntersectionObserver(es=>{
      es.forEach(e=>{
        if(e.isIntersecting){ e.target.classList.add('visible'); io.unobserve(e.target); }
      });
    },{threshold:.2});
    $$('.game-card').forEach(c=>io.observe(c));

    // 主题
    const THEME_KEY='retroIndexTheme';
    function applyTheme(t){ const dark=t==='dark'; document.body.classList.toggle('dark-theme',dark); $('#theme-toggle').setAttribute('aria-pressed',String(dark)); }
    (()=>{
      const saved=localStorage.getItem(THEME_KEY);
      const prefersDark=window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(saved || (prefersDark?'dark':'light'));
    })();
    $('#theme-toggle').addEventListener('click',()=>{
      const dark=!document.body.classList.contains('dark-theme');
      applyTheme(dark?'dark':'light'); localStorage.setItem(THEME_KEY,dark?'dark':'light');
      window.__redrawThumbnails && window.__redrawThumbnails();
    });

    // 快速键：/ 聚焦搜索
    document.addEventListener('keydown',(e)=>{
      if(e.key==='/' && document.activeElement !== $('#search')){
        e.preventDefault(); $('#search').focus();
      }
    });

    // 筛选（标签 + 关键词）
    const chips=$$('.chip'); const grid=$('#grid'); const cards=$$('.game-card',grid);
    let activeFilter='all';
    function applyFilter(){
      const kw = $('#search').value.trim().toLowerCase();
      cards.forEach(card=>{
        const tags = (card.dataset.tags||'').toLowerCase();
        const title = (card.dataset.title||'').toLowerCase();
        const tagPass = activeFilter==='all' || tags.includes(activeFilter);
        const kwPass = !kw || tags.includes(kw) || title.includes(kw);
        card.style.display = (tagPass && kwPass) ? '' : 'none';
      });
    }
    chips.forEach(ch=>{
      ch.addEventListener('click',()=>{
        chips.forEach(x=>{x.classList.remove('active'); x.setAttribute('aria-pressed','false');});
        ch.classList.add('active'); ch.setAttribute('aria-pressed','true');
        activeFilter = ch.dataset.filter; applyFilter();
      });
    });
    $('#search').addEventListener('input',applyFilter);

    // ============ 主题查询 ============
    const currentTheme=()=>document.body.classList.contains('dark-theme')?'dark':'light';

    // ============ Snake 缩略图（固定苹果 + 渐变方块 + 闭环路径） ============
    const snakeSketch = (p) => {
      const TILE = 20, W = 320, H = 320;
      const COLS = (W / TILE) | 0, ROWS = (H / TILE) | 0;

      // 路径：小范围 1~6 的蛇形路线 + 收尾回到起点边（闭环）
      const X0 = 1, X1 = 6, Y0 = 1, Y1 = 6;
      function makeRoute() {
        const r = [];
        for (let y = Y0; y <= Y1; y++) {
          if ((y - Y0) % 2 === 0) { for (let x = X0; x <= X1; x++) r.push({ x, y }); }
          else { for (let x = X1; x >= X0; x--) r.push({ x, y }); }
        }
        for (let y = Y1 - 1; y >= Y0; y--) r.push({ x: X0, y });
        return r;
      }
      const ROUTE = makeRoute(), RLEN = ROUTE.length;

      function posOnRoute(u) {
        const uWrap = ((u % RLEN) + RLEN) % RLEN;
        const i = Math.floor(uWrap), t = uWrap - i;
        const a = ROUTE[i], b = ROUTE[(i + 1) % RLEN];
        return { x: a.x + (b.x - a.x) * t, y: a.y + (b.y - a.y) * t };
      }

      const SPEED_BASE = 3.0;
      const SEG_SPACING = 0.7;
      let length = 10;
      let uHead = 0;
      let lastMillis = 0;
      let eatPulse = 0;

      // 固定苹果：路径区域内的随机格点；被吃后再刷新
      let apple = randApple();
      function randApple() {
        for (let k = 0; k < 20; k++) {
          const x = Math.floor(p.random(X0, X1 + 1));
          const y = Math.floor(p.random(Y0, Y1 + 1));
          const headG = gridHead();
          if (!(x === headG.x && y === headG.y)) return { x, y };
        }
        const headG = gridHead();
        return { x: Math.max(X0, Math.min(X1, headG.x)), y: Math.max(Y0, Math.min(Y1, headG.y)) };
      }

      const isLight = () => currentTheme() === 'light';
      function gridHead() { const pos = posOnRoute(uHead); return { x: Math.round(pos.x), y: Math.round(pos.y) }; }

      function drawBoard() {
        if (isLight()) {
          p.background(p.color(15, 28, 36));
          p.stroke(p.color(156, 174, 219, 70));
        } else {
          p.background(p.color(42, 18, 0));
          p.stroke(p.color(255, 210, 138, 70));
        }
        p.strokeWeight(1);
        for (let i = 0; i <= COLS; i++) p.line(i * TILE, 0, i * TILE, H);
        for (let j = 0; j <= ROWS; j++) p.line(0, j * TILE, W, j * TILE);
      }

      function drawApple() {
        const r = 4, pad = 4;
        const s = eatPulse > 0 ? 0.85 + 0.15 * Math.sin(eatPulse * 0.04) : 1.0;
        const cx = apple.x * TILE + TILE / 2;
        const cy = apple.y * TILE + TILE / 2;
        const w = (TILE - pad * 2) * s;
        const h = (TILE - pad * 2) * s;

        p.noStroke();
        p.fill(isLight() ? '#00e0ff' : '#ff7a00');
        p.rect(cx - w / 2, cy - h / 2, w, h, r);
      }

      function drawSnake() {
        const GAP = 4, R = 4;
        const headCol = isLight() ? p.color(0, 224, 255) : p.color(255, 122, 0);
        const tailCol = p.lerpColor(headCol, p.color(255), 0.55);

        p.noStroke();
        for (let i = length - 1; i >= 0; i--) {
          const u = uHead - i * SEG_SPACING;
          const pos = posOnRoute(u);
          const gx = Math.round(pos.x), gy = Math.round(pos.y);
          const x = gx * TILE + GAP / 2, y = gy * TILE + GAP / 2;
          const w = TILE - GAP, h = TILE - GAP;
          const t = p.constrain(1 - i / (length - 1 || 1), 0, 1);
          const col = p.lerpColor(tailCol, headCol, t);
          p.fill(col);
          const headScale = (i === 0 && eatPulse > 0) ? 1.05 : 1.0;
          const dw = w * headScale, dh = h * headScale;
          p.rect(x + (w - dw) / 2, y + (h - dh) / 2, dw, dh, R);
        }
      }

      function checkEat() {
        const g = gridHead();
        if (g.x === apple.x && g.y === apple.y) {
          eatPulse = 1;
          length = Math.min(16, length + 1); // 控制长度上限，避免缩略图过密
          apple = randApple();
        }
        if (eatPulse > 0) eatPulse++;
        if (eatPulse > 20) eatPulse = 0;
      }

      function stepHead(dt) {
        // 轻微速度起伏（视觉顺滑，不改变设计）
        const speed = SPEED_BASE * (1.0 + 0.06 * Math.sin(uHead * 0.6));
        uHead += speed * dt;
      }

      p.setup = () => {
        p.createCanvas(W, H);
        p.pixelDensity(Math.min(2, window.devicePixelRatio || 1));
        p.frameRate(60);
        lastMillis = p.millis();
      };

      p.draw = () => {
        const now = p.millis();
        const dt = Math.min(0.05, Math.max(0, (now - lastMillis) / 1000));
        lastMillis = now;

        stepHead(dt);
        checkEat();

        drawBoard();
        drawApple();
        drawSnake();
      };

      p.redrawOnce = () => { drawBoard(); drawApple(); drawSnake(); };
    };

    // ============ Gomoku 缩略图（棋盘 + 呼吸光最近一步） ============
    const gomokuSketch=(p)=>{
      const SIZE=600, PAD=64, GRID=9; const step=(SIZE-PAD*2)/(GRID-1);
      const stones=[[2,2,'black'],[3,3,'white'],[4,4,'black'],[5,5,'white'],[6,6,'black']];

      function col(){
        if(currentTheme()==='light'){
          return {bg1:p.color(15,28,36), bg2:p.color(50,68,80), grid:p.color(156,174,219,180),
                  glowA:p.color(0,224,255,170), glowB:p.color(156,174,219,120),
                  win:p.color(0,224,255,230), blackOutline:p.color(156,174,219,220)};
        }else{
          return {bg1:p.color(56,24,0), bg2:p.color(182,75,0), grid:p.color(255,210,138,180),
                  glowA:p.color(255,122,0,170), glowB:p.color(255,210,138,120),
                  win:p.color(255,180,100,230), blackOutline:p.color(255,210,138,220)};
        }
      }
      const drawBoard=(c)=>{
        for(let y=0;y<SIZE;y++){ const t=y/SIZE; p.strokeWeight(0); p.fill(p.lerpColor(c.bg1,c.bg2,t)); p.rect(0,y,SIZE,1); }
        p.stroke(c.grid); p.strokeWeight(2);
        for(let i=0;i<GRID;i++){ const x=PAD+i*step, y=PAD+i*step; p.line(PAD,y,SIZE-PAD,y); p.line(x,PAD,x,SIZE-PAD); }
      };
      function drawStone(gx,gy,color,c,isLast=false,time=0){
        const x=PAD+gx*step, y=PAD+gy*step, r=step*0.42, s=isLast? 0.92+0.08*(0.5+0.5*Math.sin(time*0.015)) : 1.0;
        p.push(); p.translate(x,y); p.scale(s);
        if(isLast){
          p.noFill();
          for(let i=0;i<4;i++){ const rr=r+7+i*7; const cc = i%2? c.glowA:c.glowB;
            cc.setAlpha(Math.max(0,130+25*Math.sin((time+i*60)*0.01)));
            p.stroke(cc); p.strokeWeight(2); p.ellipse(0,0,rr*2,rr*2);
          }
        }
        p.noStroke();
        if(color==='black'){
          p.fill(currentTheme()==='light'? p.color(18,18,18): p.color(28,20,16));
          p.ellipse(0,0,r*2,r*2);
          p.noFill(); p.stroke(c.blackOutline); p.strokeWeight(currentTheme()==='light'?2:2.2); p.ellipse(0,0,r*2-1,r*2-1);
        }else{
          p.fill(255); p.ellipse(0,0,r*2,r*2);
          p.noFill(); p.stroke(0,0,0,45); p.strokeWeight(1.6); p.ellipse(0,0,r*2-1,r*2-1);
        }
        p.pop();
      }
      p.setup=()=>{ p.createCanvas(SIZE,SIZE); p.pixelDensity(Math.min(2, window.devicePixelRatio||1)); };
      p.draw=()=>{
        const C=col(); p.background(0,0); drawBoard(C);
        const t=p.millis(); const idx=Math.floor((t/900)%stones.length);
        stones.forEach((s,i)=>drawStone(s[0],s[1],s[2],C,i===idx,t-i*180));
        const a=stones[0], b=stones[stones.length-1];
        p.stroke(C.win); p.strokeWeight(5);
        p.line(PAD+a[0]*step, PAD+a[1]*step, PAD+b[0]*step, PAD+b[1]*step);
      };
      p.redrawOnce=()=>{ p.redraw(); };
    };

    // 挂载 p5
    const snakeP5 = new p5(snakeSketch,'snake-canvas');
    const gomokuP5 = new p5(gomokuSketch,'gomoku-canvas');

    // 主题切换重绘
    window.__redrawThumbnails=()=>{ snakeP5.redrawOnce && snakeP5.redrawOnce(); gomokuP5.redrawOnce && gomokuP5.redrawOnce(); };

    // 可见性节能：在视口内才 loop
    const toggleLoop = (inst, el, on)=>{ if(!inst) return; on ? inst.loop() : inst.noLoop(); };
    const mkIO = (inst, el)=> new IntersectionObserver(([entry])=>toggleLoop(inst, el, entry.isIntersecting),{threshold:.15});
    mkIO(snakeP5, $('#snake-canvas')).observe($('#snake-canvas'));
    mkIO(gomokuP5, $('#gomoku-canvas')).observe($('#gomoku-canvas'));
    document.addEventListener('visibilitychange',()=>{ const on=!document.hidden; toggleLoop(snakeP5,$('#snake-canvas'),on); toggleLoop(gomokuP5,$('#gomoku-canvas'),on); });
  </script>
</body>
</html>
